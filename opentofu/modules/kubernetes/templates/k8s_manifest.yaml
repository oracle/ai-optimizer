# Copyright (c) 2024, 2025, Oracle and/or its affiliates.
# All rights reserved. The Universal Permissive License (UPL), Version 1.0 as shown at http://oss.oracle.com/licenses/upl
# spell-checker: disable

---
apiVersion: v1
kind: Namespace
metadata:
  name: ${label}
---
apiVersion: v1
kind: Secret
metadata:
  name: ${label}-optimizer-api-key
  namespace: ${label}
type: Opaque
stringData:
  apiKey: ${optimizer_api_key}
---
# Secret containing non-privileged DB User details.
# Used for application connectivity to database.
# User is created during cfgmgt init-containter
apiVersion: v1
kind: Secret
metadata:
  name: ${db_name}-db-authn
  namespace: ${label}
type: Opaque
stringData:
  username: AI_OPTIMIZER
  password: ${db_password}
  service: ${db_service}
---
# Secret containing privileged DB User details.
# Used to create user defined in -db-authn in init-container
apiVersion: v1
kind: Secret
metadata:
  name: ${db_name}-db-priv-authn
  namespace: ${label}
type: Opaque
stringData:
  username: ${db_username}
  password: ${db_password}
---
apiVersion: "ingress.oraclecloud.com/v1beta1"
kind: IngressClassParameters
metadata:
  name: native-ic-params
  namespace: ${label}
spec:
  compartmentId: ${compartment_ocid}
  subnetId: ${lb_subnet_ocid}
  loadBalancerName: "${label}-lb"
  reservedPublicAddressId: ${lb_ip_ocid}
  isPrivate: false
  maxBandwidthMbps: ${lb_max_shape}
  minBandwidthMbps: ${lb_min_shape}
---
apiVersion: networking.k8s.io/v1
kind: IngressClass
metadata:
  name: native-ic
  namespace: ${label}
  annotations:
    ingressclass.kubernetes.io/is-default-class: "true"
    oci-native-ingress.oraclecloud.com/network-security-group-ids: ${lb_nsgs}
    oci-native-ingress.oraclecloud.com/id: ${lb_ocid}
    oci-native-ingress.oraclecloud.com/delete-protection-enabled: "true"
spec:
  controller: oci.oraclecloud.com/native-ingress-controller
  parameters:
    scope: Namespace
    namespace: ${label}
    apiGroup: ingress.oraclecloud.com
    kind: IngressClassParameters
    name: native-ic-params
%{ if deploy_buildkit ~}
---
# Builds and pushes application images to container registry.
# Uses instance principles.
apiVersion: batch/v1
kind: Job
metadata:
  name: optimizer-buildkit
  namespace: ${label}
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: Never
      initContainers:
        - name: prepare-source-code
          image: docker.io/alpine:latest
          command:
            - sh
            - -c
            - |
              if [ "${optimizer_version}" = "Experimental" ]; then
                echo "Downloading Code from MAIN branch"
                wget -qO- https://github.com/oracle/ai-optimizer/archive/refs/heads/main.tar.gz \
                  | tar -xz -C /workspace --strip-components=1 ai-optimizer-main/src ai-optimizer-main/pyproject.toml 
              else
                echo "Downloading Code from LATEST release"
                wget -qO- https://github.com/oracle/ai-optimizer/releases/latest/download/ai-optimizer-src.tar.gz \
                  | tar -xz -C /workspace
              fi
          securityContext:
            runAsUser: 1000
            runAsGroup: 1000
          volumeMounts:
            - name: workspace
              mountPath: /workspace
        - name: init-ocir-login
          image: ghcr.io/oracle/oci-cli:latest
          command:
            - sh
            - -c
            - |
              RETRY_COUNT=0
              REPO_PATH=$(echo "${optimizer_repository_client}" | cut -d'/' -f2-)

              while [ $RETRY_COUNT -lt 10 ]; do
                RETRY_COUNT=$((RETRY_COUNT + 1))
                echo "Attempt $RETRY_COUNT of 10"

                TOKEN=$(oci raw-request --http-method GET --target-uri https://${repository_host}/20180419/docker/token | jq -r '.data.token' 2>/dev/null || echo "")
                mkdir -p /docker-config
                echo "{\"auths\":{\"${repository_host}\":{\"auth\":\"$(echo -n "BEARER_TOKEN:$TOKEN" | base64 -w0)\"}}}" > /docker-config/config.json
                chown 1000:1000 /docker-config/config.json

                HTTP_STATUS=$(oci raw-request --http-method GET \
                  --target-uri "https://${repository_host}/v2/$REPO_PATH/manifests/latest" \
                  --request-headers "{\"Authorization\": \"Bearer $TOKEN\"}" 2>/dev/null | jq -r '.status' || echo "000")

                HTTP_CODE=$(echo "$HTTP_STATUS" | cut -d' ' -f1)

                if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "404" ]; then
                  echo "Token validated: Status $HTTP_CODE"
                  exit 0
                fi

                echo "Token invalid: Status $HTTP_CODE... retrying in 10s"
                [ $RETRY_COUNT -lt 10 ] && sleep 10
              done

              echo "Failed after 10 attempts"
              exit 1
          env:
            - name: OCI_CLI_AUTH
              value: instance_principal
          volumeMounts:
            - name: docker-auth
              mountPath: /docker-config
      containers:
        - name: buildkit-client
          image: docker.io/moby/buildkit:master-rootless
          env:
            - name: BUILDKITD_FLAGS
              value: --oci-worker-no-process-sandbox --oci-worker-gc=false
          command:
            - sh
            - -c
          args:
            - |
              buildctl-daemonless.sh build \
                --no-cache \
                --progress plain \
                --frontend dockerfile.v0 \
                --local context=/workspace \
                --local dockerfile=/workspace/src/client \
                --output type=image,name=${optimizer_repository_client}:latest,push=true
          securityContext:
            seccompProfile:
              type: Unconfined
            appArmorProfile:
              type: Unconfined
            runAsUser: 1000
            runAsGroup: 1000
          volumeMounts:
            - name: workspace
              mountPath: /workspace
              readOnly: true
            - name: buildkitd-client
              mountPath: /home/user/.local/share/buildkit
            - name: docker-auth
              mountPath: /home/user/.docker
              readOnly: true
        - name: buildkit-server
          image: docker.io/moby/buildkit:master-rootless
          env:
            - name: BUILDKITD_FLAGS
              value: --oci-worker-no-process-sandbox --oci-worker-gc=false
          command:
            - sh
            - -c
          args:
            - |
              buildctl-daemonless.sh build \
                --no-cache \
                --progress plain \
                --frontend dockerfile.v0 \
                --local context=/workspace \
                --local dockerfile=/workspace/src/server \
                --output type=image,name=${optimizer_repository_server}:latest,push=true
          securityContext:
            seccompProfile:
              type: Unconfined
            appArmorProfile:
              type: Unconfined
            runAsUser: 1000
            runAsGroup: 1000
          volumeMounts:
            - name: workspace
              mountPath: /workspace
              readOnly: true
            - name: buildkitd-server
              mountPath: /home/user/.local/share/buildkit
            - name: docker-auth
              mountPath: /home/user/.docker
              readOnly: true
      volumes:
        - name: workspace
          emptyDir: {}
        - name: buildkitd-client
          emptyDir: {}
        - name: buildkitd-server
          emptyDir: {}
        - name: docker-auth
          emptyDir: {}
%{ endif }
