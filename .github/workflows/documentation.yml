# Workflow for deploying static documentation
name: Deploy Documentation/Helm to Pages

on:
  push:
    branches:
      - main
    # Limit runs to only when docs/helm change
    paths:
      - "docs/**"
      - "helm/**"
      - ".github/workflows/documentation.yml"

  # Allows running this workflow manually
  workflow_dispatch:

# Permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

# Default to bash
defaults:
  run:
    shell: bash

jobs:
  # Build job
  build:
    runs-on: ubuntu-latest
    env:
      HUGO_VERSION: 0.156.0
    steps:
      - name: Install Hugo CLI
        run: |
          wget -O ${{ runner.temp }}/hugo.deb https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.deb \
          && sudo dpkg -i ${{ runner.temp }}/hugo.deb

      - name: Install Dart Sass
        run: sudo snap install dart-sass

      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Download Hugo Theme
        run: |
          mkdir -p docs/themes/relearn \
          && curl -L $(curl -s https://api.github.com/repos/McShelby/hugo-theme-relearn/releases/latest \
          | grep "tarball_url" | cut -d '"' -f 4) \
          | tar -xz -C docs/themes/relearn --strip-components=1 --exclude='*/exampleSite'

      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v5

      - name: Install Node.js dependencies
        run: "[[ -f package-lock.json || -f npm-shrinkwrap.json ]] && npm ci || true"

      - name: Build Versioned Docs
        env:
          HUGO_CACHEDIR: ${{ runner.temp }}/hugo_cache
          HUGO_ENVIRONMENT: production
          TZ: Europe/London
          BASE_URL: "${{ steps.pages.outputs.base_url }}"
        run: |
          # --- Determine which versions to build ---
          # Latest tag = current major; also include last tag from previous major
          LATEST_TAG=$(git tag --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -1)
          if [ -z "$LATEST_TAG" ]; then
            echo "No version tags found, building main only"
            hugo --gc --minify --source docs --baseURL "${BASE_URL}/"
            exit 0
          fi

          CURRENT_MAJOR=$(echo "$LATEST_TAG" | cut -d. -f1)
          PREV_MAJOR_NUM=$(( ${CURRENT_MAJOR#v} - 1 ))

          # All tags from current major (descending order)
          mapfile -t CURRENT_TAGS < <(git tag --sort=-version:refname | grep -E "^${CURRENT_MAJOR}\.[0-9]+\.[0-9]+$")

          # Last tag from previous major (if any)
          PREV_TAG=$(git tag --sort=-version:refname | grep -E "^v${PREV_MAJOR_NUM}\.[0-9]+\.[0-9]+$" | head -1)

          # Combine all tags to build
          ALL_TAGS=("${CURRENT_TAGS[@]}")
          if [ -n "$PREV_TAG" ]; then
            ALL_TAGS+=("$PREV_TAG")
          fi

          echo "Latest tag: $LATEST_TAG"
          echo "All doc versions: ${ALL_TAGS[*]}"

          # --- Helper: generate version overlay TOML ---
          generate_version_overlay() {
            local current_version="$1"
            local overlay_file="$2"

            cat > "$overlay_file" <<EOF
          [params]
          version = '${current_version}'
          [[params.versions]]
          identifier = '${LATEST_TAG}'
          title = '${LATEST_TAG}'
          baseURL = '${BASE_URL}/'
          isLatest = true
          [[params.versions]]
          identifier = 'v0.0.0'
          title = 'v0.0.0 (dev)'
          baseURL = '${BASE_URL}/main/'
          EOF

            for TAG in "${ALL_TAGS[@]}"; do
              if [ "$TAG" != "$LATEST_TAG" ]; then
                cat >> "$overlay_file" <<EOF
          [[params.versions]]
          identifier = '${TAG}'
          title = '${TAG}'
          baseURL = '${BASE_URL}/${TAG}/'
          EOF
              fi
            done
          }

          # --- Build latest release tag to root ---
          echo "=== Building latest release ($LATEST_TAG) to root ==="
          WORKDIR=$(mktemp -d)
          git worktree add "$WORKDIR" "$LATEST_TAG"
          cp -r docs/themes "$WORKDIR/docs/themes"
          generate_version_overlay "$LATEST_TAG" "$WORKDIR/docs/version-overlay.toml"
          hugo \
            --gc --minify \
            --source "$WORKDIR/docs" \
            --destination "$GITHUB_WORKSPACE/docs/public" \
            --config hugo.toml,version-overlay.toml \
            --baseURL "${BASE_URL}/"
          git worktree remove "$WORKDIR" --force

          # --- Build main branch to /main/ ---
          echo "=== Building main branch to /main/ ==="
          generate_version_overlay "v0.0.0" "docs/version-overlay.toml"
          hugo \
            --gc --minify \
            --source docs \
            --destination "$GITHUB_WORKSPACE/docs/public/main" \
            --config hugo.toml,version-overlay.toml \
            --baseURL "${BASE_URL}/main/"

          # --- Build remaining tagged versions to subdirectories ---
          for TAG in "${ALL_TAGS[@]}"; do
            if [ "$TAG" = "$LATEST_TAG" ]; then
              continue
            fi
            echo "=== Building $TAG to /${TAG}/ ==="
            WORKDIR=$(mktemp -d)
            git worktree add "$WORKDIR" "$TAG"
            cp -r docs/themes "$WORKDIR/docs/themes"
            generate_version_overlay "$TAG" "$WORKDIR/docs/version-overlay.toml"
            hugo \
              --gc --minify \
              --source "$WORKDIR/docs" \
              --destination "$GITHUB_WORKSPACE/docs/public/${TAG}" \
              --config hugo.toml,version-overlay.toml \
              --baseURL "${BASE_URL}/${TAG}/" \
            || echo "WARNING: Build failed for $TAG, skipping"
            git worktree remove "$WORKDIR" --force
          done

      - name: Package Tags Helm chart
        run: |
          TAGS=$(git tag --sort=creatordate)
          for TAG in $TAGS; do
            echo "Processing tag: $TAG"

            # Create a temporary worktree to avoid changing the current working directory
            WORKDIR=$(mktemp -d)
            git worktree add "$WORKDIR" "$TAG"

            # Extract version from tag (remove 'v' prefix if present)
            if [[ $TAG =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              VERSION=${TAG#v}
              echo "Packaging Helm chart with version: $VERSION"
              helm package "$WORKDIR/helm" -d docs/public/helm --version "$VERSION" --app-version "$VERSION" --debug
            else
              echo "Tag $TAG does not match version format (vMAJOR.MINOR.PATCH), packaging without version override"
              helm package "$WORKDIR/helm" -d docs/public/helm --debug
            fi

            # Clean up
            git worktree remove "$WORKDIR"
          done

      - name: Package Main Helm chart
        run: |
          mkdir -p docs/public/helm
          helm package helm -d docs/public/helm --debug

      - name: Index Helm charts
        run: helm repo index docs/public/helm --url "${{ steps.pages.outputs.base_url }}/helm"

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: ./docs/public

  # Deployment job
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
